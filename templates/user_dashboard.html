<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>User Dashboard - AI Learning System</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            color: #333;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
        }

        .header {
            text-align: center;
            color: white;
            margin-bottom: 30px;
        }

        .card {
            background: white;
            border-radius: 15px;
            padding: 25px;
            margin-bottom: 20px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.1);
        }

        .insights-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .insight-card {
            background: linear-gradient(135deg, #667eea, #764ba2);
            color: white;
            padding: 20px;
            border-radius: 10px;
            text-align: center;
        }

        .insight-number {
            font-size: 2.5rem;
            font-weight: bold;
            margin-bottom: 10px;
        }

        .chat-container {
            background: #f8f9fa;
            border-radius: 10px;
            padding: 20px;
            max-height: 400px;
            overflow-y: auto;
            margin-bottom: 20px;
        }

        .message {
            margin-bottom: 15px;
            padding: 10px 15px;
            border-radius: 18px;
            max-width: 80%;
        }

        .message.user {
            background: #5a67d8;
            color: white;
            margin-left: auto;
        }

        .message.system {
            background: #e2e8f0;
            color: #4a5568;
        }

        .input-group {
            display: flex;
            gap: 10px;
        }

        .input-group input {
            flex: 1;
            padding: 12px;
            border: 2px solid #e2e8f0;
            border-radius: 25px;
            font-size: 16px;
        }

        .btn {
            background: linear-gradient(135deg, #5a67d8, #667eea);
            color: white;
            border: none;
            padding: 12px 25px;
            border-radius: 25px;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(90, 103, 216, 0.4);
        }

        .progress-bar {
            background: #e2e8f0;
            border-radius: 10px;
            height: 8px;
            margin: 10px 0;
        }

        .progress-fill {
            background: linear-gradient(135deg, #5a67d8, #667eea);
            height: 100%;
            border-radius: 10px;
            transition: width 0.3s ease;
        }

        .fact-timeline {
            position: relative;
            padding-left: 30px;
        }

        .fact-timeline::before {
            content: '';
            position: absolute;
            left: 15px;
            top: 0;
            bottom: 0;
            width: 2px;
            background: #e2e8f0;
        }

        .timeline-item {
            position: relative;
            margin-bottom: 20px;
            padding: 15px;
            background: #f8f9fa;
            border-radius: 8px;
        }

        .timeline-item::before {
            content: '';
            position: absolute;
            left: -23px;
            top: 20px;
            width: 12px;
            height: 12px;
            background: #5a67d8;
            border-radius: 50%;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>üß† User Dashboard</h1>
            <p>Personalized AI Learning Profile</p>
        </div>

        <!-- Key Insights -->
        <div class="insights-grid">
            <div class="insight-card">
                <div class="insight-number" id="totalInteractions">0</div>
                <div>Total Interactions</div>
            </div>
            <div class="insight-card">
                <div class="insight-number" id="factsLearned">0</div>
                <div>Facts Learned</div>
            </div>
            <div class="insight-card">
                <div class="insight-number" id="avgSentiment">0.0</div>
                <div>Avg Sentiment</div>
            </div>
            <div class="insight-card">
                <div class="insight-number" id="daysSince">0</div>
                <div>Days Since Joined</div>
            </div>
        </div>

        <!-- Interactive Chat -->
        <div class="card">
            <h2>üí¨ Interactive Chat</h2>
            <div class="chat-container" id="chatContainer">
                <div class="message system">
                    Hello! I'm your AI assistant. I'm learning about you as we interact. Feel free to share your thoughts, preferences, or ask me anything!
                </div>
            </div>
            <div class="input-group">
                <input type="text" id="messageInput" placeholder="Type your message here..." onkeypress="handleEnter(event)">
                <button class="btn" onclick="sendMessage()">Send</button>
            </div>
        </div>

        <!-- Learning Progress -->
        <div class="card">
            <h2>üìä Learning Progress</h2>
            <div id="learningProgress">
                <div style="margin-bottom: 20px;">
                    <h4>Interests Discovery</h4>
                    <div class="progress-bar">
                        <div class="progress-fill" id="interestsProgress" style="width: 0%"></div>
                    </div>
                    <small>Based on conversation topics and preferences</small>
                </div>
                
                <div style="margin-bottom: 20px;">
                    <h4>Communication Style</h4>
                    <div class="progress-bar">
                        <div class="progress-fill" id="styleProgress" style="width: 0%"></div>
                    </div>
                    <small>Learning your preferred communication patterns</small>
                </div>
                
                <div style="margin-bottom: 20px;">
                    <h4>Behavioral Patterns</h4>
                    <div class="progress-bar">
                        <div class="progress-fill" id="behaviorProgress" style="width: 0%"></div>
                    </div>
                    <small>Understanding your interaction habits</small>
                </div>
            </div>
        </div>

        <!-- Recent Learnings -->
        <div class="card">
            <h2>üîç Recent Learnings</h2>
            <div class="fact-timeline" id="factTimeline">
                <div class="timeline-item">
                    <strong>Start learning!</strong>
                    <p>Begin interacting to see what I learn about you.</p>
                    <small>Just now</small>
                </div>
            </div>
        </div>

        <!-- User Profile Summary -->
        <div class="card">
            <h2>üë§ Profile Summary</h2>
            <div id="profileSummary">
                <p>Your AI profile will appear here as I learn more about you through our interactions.</p>
            </div>
        </div>
    </div>

    <script>
        const userId = "{{ user_id }}";
        let sessionId = Date.now().toString();

        // Initialize dashboard
        window.addEventListener('load', function() {
            loadDashboardData();
            setInterval(loadDashboardData, 30000); // Refresh every 30 seconds
        });

        async function loadDashboardData() {
            try {
                // Load analytics
                const analytics = await fetch(`/api/users/${userId}/analytics`).then(r => r.json());
                updateInsights(analytics);
                
                // Load recent facts
                const facts = await fetch(`/api/users/${userId}/facts`).then(r => r.json());
                updateFactTimeline(facts.facts);
                updateLearningProgress(facts.facts);
                
                // Load user profile
                const user = await fetch(`/api/users/${userId}`).then(r => r.json());
                updateProfileSummary(user);
                
            } catch (error) {
                console.error('Error loading dashboard data:', error);
            }
        }

        function updateInsights(analytics) {
            document.getElementById('totalInteractions').textContent = analytics.user_summary.total_interactions;
            document.getElementById('factsLearned').textContent = analytics.user_summary.total_facts_learned;
            document.getElementById('avgSentiment').textContent = analytics.interaction_stats.average_sentiment.toFixed(1);
            
            const joinDate = new Date(analytics.user_summary.member_since);
            const daysSince = Math.floor((new Date() - joinDate) / (1000 * 60 * 60 * 24));
            document.getElementById('daysSince').textContent = daysSince;
        }

        function updateFactTimeline(facts) {
            const timeline = document.getElementById('factTimeline');
            
            if (facts.length === 0) {
                timeline.innerHTML = `
                    <div class="timeline-item">
                        <strong>Ready to learn!</strong>
                        <p>Start chatting to see what I discover about you.</p>
                        <small>Just now</small>
                    </div>
                `;
                return;
            }

            const recentFacts = facts.slice(0, 5);
            const timelineHTML = recentFacts.map(fact => `
                <div class="timeline-item">
                    <strong>${fact.category}: ${fact.fact_key}</strong>
                    <p>${fact.fact_value}</p>
                    <small>${new Date(fact.last_updated).toLocaleDateString()} - Confidence: ${fact.confidence_level}</small>
                </div>
            `).join('');
            
            timeline.innerHTML = timelineHTML;
        }

        function updateLearningProgress(facts) {
            const categories = ['interests', 'behavior', 'communication'];
            const factsByCategory = {};
            
            facts.forEach(fact => {
                if (!factsByCategory[fact.category]) {
                    factsByCategory[fact.category] = 0;
                }
                factsByCategory[fact.category]++;
            });
            
            // Update progress bars (max 10 facts per category for 100%)
            const interestsCount = factsByCategory['interests'] || 0;
            const behaviorCount = factsByCategory['behavior'] || 0;
            const communicationCount = factsByCategory['communication'] || 0;
            
            document.getElementById('interestsProgress').style.width = `${Math.min(interestsCount * 20, 100)}%`;
            document.getElementById('behaviorProgress').style.width = `${Math.min(behaviorCount * 20, 100)}%`;
            document.getElementById('styleProgress').style.width = `${Math.min(communicationCount * 20, 100)}%`;
        }

        function updateProfileSummary(user) {
            const profile = user.profile;
            if (!profile) return;
            
            const summaryHTML = `
                <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 20px;">
                    <div>
                        <h4>üó£Ô∏è Communication</h4>
                        <p>Style: ${profile.communication_style || 'Learning...'}</p>
                        <p>Language: ${profile.preferred_language || 'en'}</p>
                        <p>Technical Level: ${profile.technical_level || 'intermediate'}</p>
                    </div>
                    <div>
                        <h4>üéØ Interests</h4>
                        <p>${profile.interests ? profile.interests.join(', ') : 'Discovering your interests...'}</p>
                    </div>
                    <div>
                        <h4>üé® Hobbies</h4>
                        <p>${profile.hobbies ? profile.hobbies.join(', ') : 'Learning about your hobbies...'}</p>
                    </div>
                </div>
            `;
            
            document.getElementById('profileSummary').innerHTML = summaryHTML;
        }

        // Chat functionality
        async function sendMessage() {
            const input = document.getElementById('messageInput');
            const message = input.value.trim();
            
            if (!message) return;
            
            // Add user message to chat
            addMessageToChat(message, 'user');
            input.value = '';
            
            try {
                // Record interaction
                await fetch(`/api/users/${userId}/interactions`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        type: 'message',
                        content: message,
                        session_id: sessionId,
                        source: 'dashboard'
                    })
                });
                
                // Generate AI response (simple demo response)
                const response = generateAIResponse(message);
                setTimeout(() => {
                    addMessageToChat(response, 'system');
                }, 1000);
                
                // Trigger learning
                setTimeout(async () => {
                    await fetch(`/api/users/${userId}/learn`, { method: 'POST' });
                    loadDashboardData(); // Refresh dashboard
                }, 2000);
                
            } catch (error) {
                console.error('Error sending message:', error);
                addMessageToChat('Sorry, there was an error processing your message.', 'system');
            }
        }

        function addMessageToChat(message, sender) {
            const chatContainer = document.getElementById('chatContainer');
            const messageDiv = document.createElement('div');
            messageDiv.className = `message ${sender}`;
            messageDiv.textContent = message;
            
            chatContainer.appendChild(messageDiv);
            chatContainer.scrollTop = chatContainer.scrollHeight;
        }

        function generateAIResponse(userMessage) {
            const message = userMessage.toLowerCase();
            
            // Simple response generation based on keywords
            if (message.includes('like') || message.includes('love')) {
                return "That's interesting! I'm learning about your preferences. Tell me more about what you enjoy.";
            } else if (message.includes('help') || message.includes('how')) {
                return "I'd be happy to help! I'm also learning that you prefer asking questions when you need assistance.";
            } else if (message.includes('thank') || message.includes('thanks')) {
                return "You're welcome! I notice you're quite polite in your communication style.";
            } else if (message.includes('hello') || message.includes('hi')) {
                return "Hello! I'm learning more about you with each interaction. How are you doing today?";
            } else {
                return "Thanks for sharing that! I'm continuously learning about your communication patterns and interests.";
            }
        }

        function handleEnter(event) {
            if (event.key === 'Enter') {
                sendMessage();
            }
        }

        // Sample interactions for demo
        function addSampleInteractions() {
            const samples = [
                "I really enjoy programming and learning new technologies",
                "I prefer detailed explanations when learning something new",
                "I like working on creative projects in my free time",
                "Thanks for the help, that was very useful!"
            ];
            
            samples.forEach((sample, index) => {
                setTimeout(() => {
                    document.getElementById('messageInput').value = sample;
                    sendMessage();
                }, index * 3000);
            });
        }

        // Add demo button (optional)
        setTimeout(() => {
            if (confirm('Would you like to see a demo with sample interactions?')) {
                addSampleInteractions();
            }
        }, 2000);
    </script>
</body>
</html>